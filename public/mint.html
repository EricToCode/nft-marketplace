<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Mint New NFT</title>
  <link rel="stylesheet" href="style.css">
  <style>
    /* Optional: Add some basic styling for better layout */
    .container { max-width: 600px; margin: 20px auto; padding: 20px; border: 1px solid #ccc; border-radius: 8px; }
    label { display: block; margin-top: 10px; font-weight: bold; }
    input[type="text"], textarea, select, input[type="file"] { width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
    button { padding: 10px 20px; margin-top: 20px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
    button:hover { background-color: #0056b3; }
    #status { margin-top: 15px; font-weight: bold; }
    .error { color: red; }
    .success { color: green; }
  </style>
</head>
<body>
  <nav><a href="index.html">Home</a> | <a href="post.html">Post</a> | <a href="browse.html">Browse</a></nav>
  <div class="container">
    <h1>Mint an NFT for Your Item</h1>
    <form id="mintForm">
      <label for="categorySelect">Category:</label>
      <select id="categorySelect">
        <option value="watches">Watch</option>
        <option value="pokemon">Pokémon Card</option>
      </select>

      <label for="name">Name:</label>
      <input id="name" name="name" placeholder="Item Name" required />

      <label for="description">Description:</label>
      <textarea id="description" name="description" placeholder="Description"></textarea>

      <label for="imgFront">Front Image:</label>
      <input type="file" id="frontImage" name="frontImage" accept="image/*" required />

      <label for="imgBack">Back Image:</label>
      <input type="file" id="backImage" name="backImage" accept="image/*" required />

      <div id="watchFields">
        <label for="serialNumber">Serial Number:</label>
        <input id="serialNumber" name="serialNumber" placeholder="Serial Number" />
        <label for="caseColor">Case Color:</label>
        <input id="caseColor" name="caseColor" placeholder="Case Color" />
        <label for="dialColor">Dial Color:</label>
        <input id="dialColor" name="dialColor" placeholder="Dial Color" />
      </div>

      <div id="cardFields">
        <label for="rarity">Rarity:</label>
        <input id="rarity" name="rarity" placeholder="Rarity" />
        <label for="setNumber">Set Number:</label>
        <input id="setNumber" name="setNumber" placeholder="Set Number" />
      </div>

      <button type="submit">Mint NFT</button>
    </form>
    <p id="status"></p>
  </div>

  <script>
    // Get references to elements
    const categorySelect = document.getElementById('categorySelect');
    const watchFieldsDiv = document.getElementById('watchFields');
    const cardFieldsDiv = document.getElementById('cardFields');
    const mintForm = document.getElementById('mintForm');
    const statusPara = document.getElementById('status');
    const frontImageInput = document.getElementById('frontImage'); // Get file input elements
    const backImageInput = document.getElementById('backImage');

    // --- FIX: Function to update field visibility ---
    function updateCategoryFields() {
      const selectedCategory = categorySelect.value;
      // Hide both first, then show the relevant one
      watchFieldsDiv.style.display = 'none';
      cardFieldsDiv.style.display = 'none';

      if (selectedCategory === 'watches') {
        watchFieldsDiv.style.display = 'block';
      } else if (selectedCategory === 'pokemon') {
        cardFieldsDiv.style.display = 'block';
      }
    }

    // --- FIX: Event listener for category change ---
    categorySelect.addEventListener('change', updateCategoryFields);

    // --- FIX: Call the function once on page load ---
    document.addEventListener('DOMContentLoaded', updateCategoryFields);

    // Handle mint form submission
    mintForm.addEventListener('submit', async (event) => {
      event.preventDefault(); // Prevent default form submission
      statusPara.textContent = 'Processing...';
      statusPara.className = ''; // Reset status class

      const formData = new FormData(); // Use FormData to handle multipart/form-data

      // Append common fields
      formData.append('category', categorySelect.value);
      formData.append('name', document.getElementById('name').value);
      formData.append('description', document.getElementById('description').value);

      // --- FIX: Append files with correct names ('frontImage', 'backImage') ---
      if (frontImageInput.files.length > 0) {
        formData.append('frontImage', frontImageInput.files[0]);
      } else {
         statusPara.textContent = '❌ Front image is required.';
         statusPara.className = 'error';
         return; // Stop submission if file is missing
      }
      if (backImageInput.files.length > 0) {
         formData.append('backImage', backImageInput.files[0]);
      } else {
          statusPara.textContent = '❌ Back image is required.';
          statusPara.className = 'error';
          return; // Stop submission if file is missing
      }


      // Append category-specific fields
      if (categorySelect.value === 'watches') {
        formData.append('serialNumber', document.getElementById('serialNumber').value);
        formData.append('caseColor', document.getElementById('caseColor').value);
        formData.append('dialColor', document.getElementById('dialColor').value);
      } else if (categorySelect.value === 'pokemon') {
        formData.append('rarity', document.getElementById('rarity').value);
        formData.append('setNumber', document.getElementById('setNumber').value);
      }

      statusPara.textContent = 'Uploading images and minting NFT... Please wait.';

      try {
        const response = await fetch('/api/mint-nft', {
          method: 'POST',
          body: formData // FormData sets the correct Content-Type header automatically
        });

        const body = await response.json(); // Always try to parse JSON

        if (response.ok) {
          statusPara.innerHTML = `✅ NFT minted successfully!<br>Contract: ${body.contractAddress}<br>TokenID: ${body.tokenId}<br>Tx: ${body.mintTxHash}`;
          statusPara.className = 'success';
          mintForm.reset(); // Optionally reset the form
          updateCategoryFields(); // Reset field visibility after form reset
        } else {
          // Use the error message from the server response if available
          statusPara.textContent = `❌ Error: ${body.error || `HTTP ${response.status}`}`;
          statusPara.className = 'error';
        }
      } catch (error) {
        console.error('Minting error:', error);
        statusPara.textContent = '❌ An unexpected error occurred. Check console for details.';
        statusPara.className = 'error';
      }
    });
  </script>
</body>
</html>
